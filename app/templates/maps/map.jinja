{% extends "base.jinja" %}

{% block content %}
    <div id="map" style="width: 100%; height: 600px;"></div>

    <!-- Dodanie formularza wyboru punktów -->
    <div>
        <label for="start-points">Wybierz punkt startowy:</label>
        <select id="start-points">
            {% for poi in pois %}
                <option value="{{ poi.id }}">{{ poi.name }}</option>
            {% endfor %}
        </select>

        <label for="end-points">Wybierz punkt końcowy:</label>
        <select id="end-points">
            {% for poi in pois %}
                <option value="{{ poi.id }}">{{ poi.name }}</option>
            {% endfor %}
        </select>

        <button onclick="getRoute()">Pokaż trasę</button>
    </div>

<script>
    // Inicjalizacja mapy (domyślne współrzędne centrum)
    var map = L.map('map').setView([51.74708, 19.45404], 13);

    // Warstwa z mapą (OpenStreetMap)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Dodawanie punktów POI z bazy danych
    {% for poi in pois %}
        L.marker([{{ poi.coordinates.x }}, {{ poi.coordinates.y }}]).addTo(map)
            .bindPopup("{{ poi.name }}");
    {% endfor %}

    // Dodawanie stref zagrożenia
    {% for area in danger_areas %}
        L.polygon(
            {{ area.coordinates | safe }},
            {
                color: 'red',
                fillColor: 'red',
                fillOpacity: 0.5
            }
        ).addTo(map)
        .bindPopup("{{ area.name }}");
    {% endfor %}

    // Dodawanie stref pomocy
    {% for area in relief_areas %}
        L.polygon(
            {{ area.coordinates | safe }},
            {
                color: 'blue',
                fillColor: 'blue',
                fillOpacity: 0.5
            }
        ).addTo(map)
        .bindPopup("{{ area.name }}");
    {% endfor %}

    // Funkcja do pobierania trasy
    function getRoute() {
        var startId = document.getElementById('start-points').value;
        var endId = document.getElementById('end-points').value;

        // Wywołanie backendu po trasę
        fetch(`/maps/${startId}/${endId}`)
            .then(response => response.json())
            .then(data => {
                if (data.route) {
                    // Rysowanie trasy na mapie
                    var route = data.route.coordinates;
                    var latLngs = route.map(function(coord) {
                        return [coord[1], coord[0]];  // Zamiana x, y na lat, lng
                    });

                    // Dodanie linii trasy na mapie (czerwona linia)
                    L.polyline(latLngs, {color: 'red'}).addTo(map);
                }
            })
            .catch(error => {
                console.error('Error fetching route:', error);
            });
    }
</script>
{% endblock %}
